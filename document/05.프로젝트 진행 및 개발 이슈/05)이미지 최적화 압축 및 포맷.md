# [이미지 최적화] 압축 및 포맷

### 1. [이미지 최적화] png, gif ,.. -> jpeg 무손실 압축 포맷

#### 1)  핵심 코드 - gm(GraphicsMagick for node)

```js
gm(buf, "test.jpg")
	// 압축
	.compress("JPEG")
	.toBuffer("JPEG", function(err, buffer) {
		if (err) {
			console.log(err);
			reject(
				new Error("err" + JSON.stringify(err))
			);
		} else {
			resolve(buffer);
		}
	});
```

#### 2) 테스트 결과

	####   좋은 사례: png(608.6kb) => jpg(183.0kb)

![image-20180529023432562](/var/folders/gh/lmckw4456mvbkzbf93mgkf4w0000gn/T/abnerworks.Typora/image-20180529023432562.png)

### 2. [이미지 최적화] jpg -> webp 

#### 1) webp 소개

![image-20180529023659699](/var/folders/gh/lmckw4456mvbkzbf93mgkf4w0000gn/T/abnerworks.Typora/image-20180529023659699.png)

#### 2) 핵심코드 - gm(GraphicsMagick for node)

```js
/**
 * convertPic2Webp
 * input : buffer image data
 * output: buffer image data
 */
convertPic2Webp: buf => {
	return new Promise(resolve => {
		gm(buf, "test.jpg").toBuffer("webp", function(err, buffer) {
			if (err) {
				console.log(err);
				reject(new Error("err" + JSON.stringify(err)));
			} else {
				resolve(buffer);
			}
		});
	});
}
```

#### 3) 사용 결과 화면

![image-20180529023920074](/var/folders/gh/lmckw4456mvbkzbf93mgkf4w0000gn/T/abnerworks.Typora/image-20180529023920074.png)

#### 4) 문제점 발생 - 크롬 전용 이미지 형식(webp), iOS 사파리에서 사용 불가능

![image-20180529024351894](/var/folders/gh/lmckw4456mvbkzbf93mgkf4w0000gn/T/abnerworks.Typora/image-20180529024351894.png)

해결 코드

```js
// userAgent를 검사하여 Chrome 이 없는 경우 확장자를 jpg로 요청한다.
if (window.navigator.userAgent.indexOf("Chrome") == -1)
	path = path.slice(0, path.lastIndexOf(".")) + ".jpg";
```